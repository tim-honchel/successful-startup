@*displays all the business plans belonging to the current user*@

@page "/plans"

@*for getting current user information*@
@inject AuthenticationStateProvider provider

@using Microsoft.AspNetCore.Components.Authorization @*for AuthenticationStateProvider*@
@using SuccessfulStartup.Api.ViewModels

<h1 id="header">Your Business Plans</h1>
<br />

<CascadingAuthenticationState> @*provides authentication and authorization state data*@
    <AuthorizeView> @*determines which content to show, based on user authorization*@

        <Authorized>

            <p>Click on a plan to see more details</p>
            <br />

            <table id="plans" class="table">
                <tr>
                    <th>Title</th>
                    <th>Description</th>
                </tr>
                @foreach (var plan in plans)
                {
                    <tr id="plan">
                        <td><a href="/plans/@plan.Id">@plan.Name</a></td>
                        <td>@plan.Description</td>
                    </tr>
                }
            </table>

            <p style="color:red">@message</p>

        </Authorized>

        <NotAuthorized>
            <p style="color:red">You must be logged in to see this information.</p>
        </NotAuthorized>

    </AuthorizeView>
</CascadingAuthenticationState>

<br />
<p><a href="/plans/new">Create a new plan</a></p>

@code {
    private List<BusinessPlanViewModel> plans { get; set; } = new List<BusinessPlanViewModel>();
    private string message = "Loading...";


    protected override async Task OnParametersSetAsync() @*don't use OnInitialized, causes runtime error where model can't be found*@
    {
        var authenticationState = await provider.GetAuthenticationStateAsync();
        var user = authenticationState.User.Identity.Name;
        var authorId = await ApiCallService.GetUserIdByUsernameAsync(user); // service manages all HTTPClient requests to the API
        try
        {
            plans = await ApiCallService.GetAllPlansByAuthorIdAsync(authorId); // service manages all HTTPClient requests to the API
            message = "";
        }
        catch (Exception)
        {
            message = "Failed to load business plans from database.";
        }
    }
}
